<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Denser, Cooler, Faster, Stronger: PHP On ARM Microservers</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Denser, Cooler, Faster, Stronger: PHP On ARM Microservers</h1>
</header>
<section data-field="body" class="e-content">
<section name="fc62" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="b1b5" id="b1b5" class="graf graf--h3 graf--leading graf--title">Denser, Cooler, Faster, Stronger: PHP On ARM Microservers</h3><p name="59ad" id="59ad" class="graf graf--p graf-after--h3"><a href="http://www.arm.com/" data-href="http://www.arm.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">ARM</a> are the world’s largest designer of semiconductors. They design the processors that run 90% of the world’s smartphones, as well as countless chips inside cars, home electronics, and more-or-less any other thing you can think of the has some electronic smarts to it. They are not so well known as designers of server CPUs, but that may all be about to change.</p><p name="5cd5" id="5cd5" class="graf graf--p graf-after--p">Last year ARM hired me to help move the PHP-based <a href="http://arm.com/" data-href="http://arm.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">arm.com</a> away from the ageing Windows servers it was running on, and onto shiny new ARM-based microservers. The idea being that if ARM servers were now a serious proposition for enterprise data centres, it would certainly make sense for ARM themselves to be using them.</p><p name="ec69" id="ec69" class="graf graf--p graf-after--p">The hardware of choice was HP’s <a href="https://www.hpe.com/uk/en/servers/moonshot.html" data-href="https://www.hpe.com/uk/en/servers/moonshot.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Moonshot</a> platform, a microserver chassis providing power, cooling and networking for up to 45 microserver cartridges, in this case the <a href="http://www8.hp.com/uk/en/products/proliant-servers/product-detail.html?oid=7398907" data-href="http://www8.hp.com/uk/en/products/proliant-servers/product-detail.html?oid=7398907" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">ProLiant m400</a>.*</p><figure name="ea0d" id="ea0d" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 466px; max-height: 556px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 119.30000000000001%;"></div><img class="graf-image" data-image-id="0*JGnSU2_IPJtsl5uI.jpg" data-width="466" data-height="556" src="https://cdn-images-1.medium.com/max/800/0*JGnSU2_IPJtsl5uI.jpg"></div></figure><p name="79f7" id="79f7" class="graf graf--p graf-after--figure">A fully-loaded HP Moonshot chassis, without the top cover.</p><p name="98cb" id="98cb" class="graf graf--p graf-after--p">The m400 packs quite a punch for something no larger than the average paperback book –</p><p name="1341" id="1341" class="graf graf--p graf-after--p">CPU AppliedMicro™ X-Gene™ ARMv8 (eight 64-bit cores at up to 2.4GHz) Memory 64GB of DDR3 PC3L-12800 (1600 MHz) SODIMM Low Voltage Memory Storage 120GB / 240GB /480GB SSD Networking 2x 10 Gigabit NICs</p><p name="3459" id="3459" class="graf graf--p graf-after--p">While the stats above are impressive, they’re clearly not quite at the same level as the latest Intel 3GHz, 18-core-monsters. The idea, however, is that you can fit 45 of them into the space of one or two traditional servers, and they produce less heat while using less power, which gives you a lower total cost of ownership.</p><p name="841a" id="841a" class="graf graf--p graf-after--p">These servers all run the latest Ubuntu Linux, which fully supports the 64 bit ARM CPU architecture. It is therefore not especially challenging to get a simple PHP application up and running on a single ARM server — you install a basic stack using apt-get, and off you go. The interesting part comes with scaling and fault tolerance.</p><p name="afa5" id="afa5" class="graf graf--p graf-after--p">Web traffic can be spread across several machines easily enough — we nominated two cartridges (sharing a single virtual IP address) to run <a href="https://www.nginx.com/" data-href="https://www.nginx.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">nginx</a> as a reverse proxy. This balanced traffic across six other cartridges acting as web servers. Since the cartridges come with so much memory we were also able to configure these to act as caches for static assets, allowing us to handle more traffic.</p><p name="88c6" id="88c6" class="graf graf--p graf-after--p">Scaling the database was a more tricky problem. The most common way to make a database handle more traffic is to install it on a larger machine. With microsevers this is obviously not an option. Instead, we went for <a href="https://www.percona.com/software/mysql-database/percona-xtradb-cluster" data-href="https://www.percona.com/software/mysql-database/percona-xtradb-cluster" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">MySQL Percona XtraDB Cluster</a> (or PXC for short). This is a modified form of MySQL that provides horizontal scaling across multiple machines. It’s a bit of pain to configure, but once it’s up and running it’s quite reliable. Quite rightly it prioritises data consistency over availability, so if you manage to get it into a state where it isn’t sure that all of its members have a clear picture of the database (and we did) then it will stop responding to queries, bringing down your website (and it did). In our case this was down to tables that didn’t have a primary key (remember, this was a legacy code base filled with all kinds of surprises). We installed PXC on five cartridges, giving us plenty of capacity to handle load and plenty of failure tolerance.</p><p name="70a8" id="70a8" class="graf graf--p graf-after--p">A multi-node database requires something to load balance it, and <a href="http://www.haproxy.org/" data-href="http://www.haproxy.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">HAProxy</a> was our tool of choice here. It offers built-in support for load balancing MySQL, and is pretty straightforward to configure. After much deliberation we opted to install a separate HAProxy instance on each web server, avoiding each individual web server having any single point of failure besides itself.</p><p name="de5f" id="de5f" class="graf graf--p graf-after--p">Session storage is a problem common across most serious PHP implementations, and ours was no different. We went for Memcache, which made sense given the amount of memory available on the ProLiant cartridges, and given our collective experience with it, but I’m not a huge fan of this approach. We also needed to use Memcache to store a few bits of application data and mixing all of that up together seems like bad news. If I did the project again I’d be keen to try <a href="http://redis.io/topics/cluster-tutorial" data-href="http://redis.io/topics/cluster-tutorial" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Redis Cluster</a>, which seems like a great fit.</p><p name="f817" id="f817" class="graf graf--p graf-after--p">On the web servers themselves we kept things fairly simple — we had to use Apache, since it hooked into an Enterprise Single Sign-On service that ARM was already using. We used <a href="https://jezhalford.com/2015/01/28/php-mail-function-linux-and-an-external-smtp-server/" data-href="https://jezhalford.com/2015/01/28/php-mail-function-linux-and-an-external-smtp-server/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">msmtp</a> to make PHP’s mail() function work as it did on the old Windows server, and we updated a hundred or so MSSQL queries to work with MySQL.</p><p name="1205" id="1205" class="graf graf--p graf-after--p">For file storage, we considered clustering the web nodes together using <a href="http://ceph.com/" data-href="http://ceph.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Ceph</a> or <a href="https://www.gluster.org/" data-href="https://www.gluster.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Gluster</a>, but in the end kept things simple by mounting an external file server that ARM already had available. Since there were so many logs being generated on so many machines, we also configured log aggregation from the various web, database and load-balancer nodes to a single “management” node using <a href="http://www.rsyslog.com/" data-href="http://www.rsyslog.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">rsyslog</a>. This was a fairly basic solution, and something like <a href="https://www.elastic.co/products/logstash" data-href="https://www.elastic.co/products/logstash" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">logstash</a> would have been nice to try if we’d had the time. Finally, a multi-server architecture really highlights the advantage of a configuration management tool. We used <a href="http://www.ansible.com/" data-href="http://www.ansible.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Ansible</a> to provision and control the various nodes.</p><p name="89a1" id="89a1" class="graf graf--p graf-after--p graf--trailing">*ARM don’t manufacture any hardware themselves, they license their designs to manufacturers. You’ll therefore never see an ARM-branded server, but the m400s have ARM-designed CPUs inside.</p></div></div></section><section name="a5e1" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="ab88" id="ab88" class="graf graf--p graf--leading graf--trailing"><em class="markup--em markup--p-em">Originally published at </em><a href="https://jezhalford.com/2015/12/30/denser-cooler-faster-stronger-php-on-arm-microservers/" data-href="https://jezhalford.com/2015/12/30/denser-cooler-faster-stronger-php-on-arm-microservers/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><em class="markup--em markup--p-em">jezhalford.com</em></a><em class="markup--em markup--p-em"> on December 30, 2015.</em></p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@jezhalford" class="p-author h-card">Jez Halford</a> on <a href="https://medium.com/p/eb9d0cb74226"><time class="dt-published" datetime="2015-12-30T16:18:49.000Z">December 30, 2015</time></a>.</p><p><a href="https://medium.com/@jezhalford/denser-cooler-faster-stronger-php-on-arm-microservers-eb9d0cb74226" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on March 18, 2019.</p></footer></article></body></html>